<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>Go/No-Go —Ç–µ—Å—Ç (–º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100vh;
            touch-action: manipulation;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
            padding: 10px;
            transition: background-color 0.3s, color 0.3s;
            background-color: #0a0a1a;
            color: white;
        }

        body.light-theme {
            background-color: #e6f0fa;
            color: #003366;
        }

        .main-panels {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
            position: relative;
            transition: transform 0.5s ease-in-out;
        }

        .left-column {
            flex: 2;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.5s ease-in-out;
        }

        .right-column {
            flex: 1;
            min-width: 280px;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transform: translateX(50px);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            pointer-events: none;
        }

        .right-column.visible {
            opacity: 1;
            transform: translateX(0);
            pointer-events: all;
        }

        #account-panel, #settings-panel, #history-panel, #stats-panel, #info-panel {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            width: 100%;
            transition: background-color 0.3s, border-color 0.3s;
            background-color: #1a1a2e;
            border: 2px solid #2a2a4a;
        }

        #info-panel {
            margin-top: 20px;
            font-size: 0.95em;
        }

        body.light-theme #account-panel,
        body.light-theme #settings-panel,
        body.light-theme #history-panel,
        body.light-theme #stats-panel,
        body.light-theme #info-panel {
            background-color: #ffffff;
            border: 2px solid #b8d9ff;
            box-shadow: 0 4px 10px rgba(0,51,102,0.1);
        }

        #account-panel input, #account-panel select, #settings-panel select {
            padding: 12px;
            margin: 8px 5px;
            font-size: 16px;
            border-radius: 8px;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
            border: 1px solid #4a6a9a;
            background-color: #2a2a4a;
            color: white;
            width: calc(100% - 20px);
            max-width: 300px;
            -webkit-appearance: none;
            appearance: none;
        }

        body.light-theme #account-panel input,
        body.light-theme #account-panel select,
        body.light-theme #settings-panel select {
            border: 1px solid #99bbff;
            background-color: #f0f5ff;
            color: #003366;
        }

        button {
            padding: 14px 28px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 10px;
            margin: 8px 5px;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            background-color: #2a4a8a;
            color: white;
            border: 1px solid #4a8ac0;
            -webkit-appearance: none;
            appearance: none;
            min-width: 120px;
            min-height: 48px;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
        }

        button:active {
            transform: scale(0.97);
            background-color: #1a3a7a;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–Ω—Å–æ—Ä–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏ */
        button.touch-pressed {
            transform: scale(0.95);
            background-color: #1a3a7a;
            transition: transform 0.05s, background-color 0.05s;
        }

        body.light-theme button.touch-pressed {
            background-color: #99bbff;
        }

        body.light-theme button {
            background-color: #b8d9ff;
            color: #003366;
            border: 1px solid #4a8ac0;
        }

        body.light-theme button:active {
            background-color: #99bbff;
        }

        #reset-btn {
            background-color: #b84a4a;
            color: white;
            border-color: #c66;
        }

        #reset-btn:active {
            background-color: #a33;
        }

        body.light-theme #reset-btn {
            background-color: #ffb8b8;
            color: #600;
            border-color: #c66;
        }

        body.light-theme #reset-btn:active {
            background-color: #ff9999;
        }

        #theme-toggle {
            background: none;
            border: 2px solid #4a8ac0;
            padding: 10px 18px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            transition: 0.2s;
            margin-left: 10px;
            color: inherit;
            min-width: auto;
            min-height: auto;
        }

        #theme-toggle:active {
            transform: scale(0.95);
            background-color: rgba(74, 138, 192, 0.2);
        }

        .settings-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .active-account {
            margin-top: 10px;
            font-weight: bold;
            color: #4a8ac0;
            font-size: 16px;
            padding: 10px;
        }

        #history-list {
            max-height: 150px;
            overflow-y: auto;
            text-align: left;
            font-size: 14px;
            margin-top: 10px;
            padding: 5px;
            border-top: 1px solid #4a6a9a;
            -webkit-overflow-scrolling: touch;
        }

        body.light-theme #history-list {
            border-top-color: #b8d9ff;
        }

        .history-item {
            padding: 8px;
            border-bottom: 1px dashed #4a6a9a;
        }

        body.light-theme .history-item {
            border-bottom-color: #b8d9ff;
        }

        .stats-summary {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 15px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background-color: rgba(74, 106, 154, 0.2);
            border-radius: 5px;
        }

        body.light-theme .stats-row {
            background-color: #e6f0fa;
        }

        .trend-indicator {
            font-weight: bold;
        }

        .trend-up { color: #4a8ac0; }
        .trend-down { color: #b84a4a; }
        .trend-equal { color: #aa8a4a; }

        .chart-container {
            margin-top: 15px;
            height: 180px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        canvas {
            width: 100%;
            height: 150px;
            background: transparent;
            display: block;
            touch-action: none;
        }

        .chart-labels {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 5px;
            font-size: 12px;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 15px;
            height: 3px;
            border-radius: 2px;
        }

        .duration-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }

        .duration-btn {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 20px;
            background-color: transparent;
            border: 1px solid currentColor;
            cursor: pointer;
            min-width: 60px;
            min-height: 40px;
        }

        .duration-btn.active {
            background-color: #4a8ac0;
            border-color: #4a8ac0;
            color: white;
        }

        body.light-theme .duration-btn.active {
            background-color: #4a8ac0;
            border-color: #4a8ac0;
            color: white;
        }

        #light-container {
            margin: 30px 0;
            touch-action: none;
            display: flex;
            justify-content: center;
            position: relative;
        }

        .light {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background-color: #2a2a4a;
            transition: background-color 0.05s;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(74, 138, 192, 0.3);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        /* –ó–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –∫—Ä—É–∂–∫–∞ (–∫–∞–∫ –∑–∞–¥—É–º—ã–≤–∞–ª–æ—Å—å) */
        .light.green {
            background-color: #2ecc71;
            box-shadow: 0 0 30px #2ecc71;
        }

        .light.red {
            background-color: #e74c3c;
            box-shadow: 0 0 30px #e74c3c;
        }

        body.light-theme .light {
            background-color: #b8d9ff;
        }

        body.light-theme .light.green {
            background-color: #2ecc71;
            box-shadow: 0 0 30px #2ecc71;
        }

        body.light-theme .light.red {
            background-color: #e74c3c;
            box-shadow: 0 0 30px #e74c3c;
        }

        #timer {
            font-size: 32px;
            font-weight: bold;
            margin: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 10;
            pointer-events: none;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 5px 15px;
            border-radius: 30px;
            backdrop-filter: blur(2px);
            white-space: nowrap;
        }

        body.light-theme #timer {
            color: #003366;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            background-color: rgba(255, 255, 255, 0.5);
        }

        #info {
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        #info p {
            margin: 8px 0;
        }

        #result {
            font-size: 18px;
            margin-top: 20px;
            text-align: center;
            max-width: 600px;
        }

        @media (max-width: 800px) {
            .main-panels {
                flex-direction: column;
                align-items: center;
            }
            .left-column, .right-column {
                width: 100%;
            }
            .right-column {
                transform: translateY(30px);
            }
            .right-column.visible {
                transform: translateY(0);
            }
        }

        @media (max-width: 600px) {
            .light {
                width: 150px;
                height: 150px;
            }
            #timer {
                font-size: 24px;
                padding: 4px 12px;
            }
            button {
                padding: 12px 24px;
                font-size: 15px;
                min-height: 48px;
            }
            #account-panel, #settings-panel, #history-panel, #stats-panel, #info-panel {
                padding: 15px;
            }
            #account-panel input, #account-panel select, #settings-panel select {
                padding: 10px;
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="main-panels centered" id="mainPanels">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="left-column" id="leftColumn">
            <div id="account-panel">
                <h2>üë§ –ê–∫–∫–∞—É–Ω—Ç—ã</h2>
                <select id="account-select">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å --</option>
                </select>
                <button id="load-account">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                <hr>
                <input type="text" id="new-name" placeholder="–ò–º—è">
                <input type="number" id="new-age" placeholder="–í–æ–∑—Ä–∞—Å—Ç" min="1" max="120">
                <button id="create-account">–°–æ–∑–¥–∞—Ç—å</button>
                <button id="delete-account" style="background-color:#b84a4a;">–£–¥–∞–ª–∏—Ç—å</button>
                <div id="active-account-display" class="active-account"></div>
            </div>

            <div id="settings-panel">
                <div class="settings-header">
                    <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                    <button id="theme-toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåì –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
                </div>
                <div>
                    <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 
                        <select id="test-duration">
                            <option value="30">30 —Å–µ–∫—É–Ω–¥</option>
                            <option value="60" selected>60 —Å–µ–∫—É–Ω–¥</option>
                        </select>
                    </label>
                </div>
                <div>
                    <label>–†–µ–∂–∏–º: 
                        <select id="mode-select">
                            <option value="click">–ö–ª–∏–∫ (–∑–µ–ª—ë–Ω—ã–π/–∫—Ä–∞—Å–Ω—ã–π)</option>
                            <option value="greenonly">–¢–æ–ª—å–∫–æ –∑–µ–ª—ë–Ω—ã–π</option>
                        </select>
                    </label>
                </div>
                <button id="start-btn">‚ñ∂ –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç</button>
            </div>

            <div id="history-panel" style="display: none;">
                <h2>üìú –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
                <div id="history-list"></div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="right-column" id="rightColumn">
            <div id="stats-panel">
                <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div class="duration-selector">
                    <button class="duration-btn active" data-duration="30">30 —Å–µ–∫</button>
                    <button class="duration-btn" data-duration="60">60 —Å–µ–∫</button>
                </div>
                <div class="stats-summary" id="stats-summary"></div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #4a8ac0;"></div>
                        <span>–¢–æ—á–Ω–æ—Å—Ç—å</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #9b4ac0;"></div>
                        <span>–°—Ä–µ–¥–Ω—è—è —Ä–µ–∞–∫—Ü–∏—è</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="accuracy-chart"></canvas>
                    <div class="chart-labels" id="chart-labels"></div>
                </div>
                <p style="font-size:0.8em; margin-top:5px;">–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Ç–µ—Å—Ç–æ–≤</p>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
            <div id="info-panel">
                <div class="datetime" id="currentDateTime"></div>
                <div class="today-count" id="todayCount"></div>
                <div class="motivation-message" id="motivationMessage"></div>
            </div>
        </div>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å —Ç–µ—Å—Ç–∞ -->
    <div id="test-area" style="display: none;">
        <div id="light-container">
            <div id="circle" class="light"></div>
            <div id="timer">0.0 / 60 —Å</div>
        </div>
        <div id="info">
            <p>–£—Å–ø–µ—Ö–∏: <span id="success-count">0</span></p>
            <p>–û—à–∏–±–∫–∏: <span id="error-count">0</span></p>
            <p>–ü—Ä–æ–ø—É—Å–∫–∏: <span id="miss-count">0</span></p>
            <p>–°—Ä–µ–¥–Ω—è—è —Ä–µ–∞–∫—Ü–∏—è (–º—Å): <span id="avg-reaction">-</span></p>
            <p>–ú–∏–Ω. —Ä–µ–∞–∫—Ü–∏—è: <span id="min-reaction">-</span></p>
            <p>–ú–∞–∫—Å. —Ä–µ–∞–∫—Ü–∏—è: <span id="max-reaction">-</span></p>
            <p class="reaction-info" id="reaction-quality">-</p>
        </div>
    </div>

    <div id="result"></div>
    <button id="save-btn" style="display: none;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
    <button id="reset-btn" style="display: none;">‚Ü∫ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>

    <script>
        // ---------- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç–∞ ----------
        let testActive = false;
        let startTime;
        let timerInterval;
        let successes = 0, errors = 0, misses = 0;
        let currentStimulus = null;
        let stimulusTimeout = null;
        let nextStimulusTimeout = null;
        let mode = 'click';
        let testDuration = 60;

        let reactionTimes = [];
        let greenStimulusStart = 0;

        let accounts = {};
        let currentAccount = null;

        // –î–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        let currentStatsDuration = '60';

        // –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        const motivationMessages = [
            "–ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç –¥–µ–ª–∞–µ—Ç —Ç–µ–±—è –ª—É—á—à–µ! üåü",
            "–°–µ–≥–æ–¥–Ω—è —Ç—ã —É–∂–µ –ª—É—á—à–µ, —á–µ–º –≤—á–µ—Ä–∞! üìà",
            "–†–µ–∞–∫—Ü–∏—è –∫–∞–∫ —É –Ω–∏–Ω–¥–∑—è! ü•∑",
            "–¢—Ä–µ–Ω–∏—Ä—É–π —Ä–µ–∞–∫—Ü–∏—é, —Å–ø–∞—Å–∞–π –º–∏—Ä! ü¶∏",
            "–ë—ã—Å—Ç—Ä–µ–µ —Å–≤–µ—Ç–∞! ‚ö°",
            "–¢—ã –Ω–∞ –≤–µ—Ä–Ω–æ–º –ø—É—Ç–∏ –∫ —É—Å–ø–µ—Ö—É! üéØ",
            "–ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ - –±–æ–ª—å—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã! üë£",
            "–¢–≤–æ–π –º–æ–∑–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ 100%! üß†",
            "–ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ! üí™",
            "–ö–∞–∂–¥–∞—è –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞ –Ω–∞ —Å—á–µ—Ç—É! ‚è±Ô∏è"
        ];

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const body = document.body;
        const mainPanels = document.getElementById('mainPanels');
        const leftColumn = document.getElementById('leftColumn');
        const rightColumn = document.getElementById('rightColumn');
        const accountPanel = document.getElementById('account-panel');
        const settingsPanel = document.getElementById('settings-panel');
        const historyPanel = document.getElementById('history-panel');
        const historyList = document.getElementById('history-list');
        const statsPanel = document.getElementById('stats-panel');
        const statsSummary = document.getElementById('stats-summary');
        const chartCanvas = document.getElementById('accuracy-chart');
        const chartLabels = document.getElementById('chart-labels');
        const testArea = document.getElementById('test-area');
        const circle = document.getElementById('circle');
        const timerEl = document.getElementById('timer');
        const successSpan = document.getElementById('success-count');
        const errorSpan = document.getElementById('error-count');
        const missSpan = document.getElementById('miss-count');
        const avgReactionSpan = document.getElementById('avg-reaction');
        const minReactionSpan = document.getElementById('min-reaction');
        const maxReactionSpan = document.getElementById('max-reaction');
        const reactionQualitySpan = document.getElementById('reaction-quality');
        const resultDiv = document.getElementById('result');
        const saveBtn = document.getElementById('save-btn');
        const resetBtn = document.getElementById('reset-btn');
        const startBtn = document.getElementById('start-btn');
        const accountSelect = document.getElementById('account-select');
        const loadAccountBtn = document.getElementById('load-account');
        const createAccountBtn = document.getElementById('create-account');
        const deleteAccountBtn = document.getElementById('delete-account');
        const newName = document.getElementById('new-name');
        const newAge = document.getElementById('new-age');
        const testDurationSelect = document.getElementById('test-duration');
        const modeSelect = document.getElementById('mode-select');
        const activeAccountDisplay = document.getElementById('active-account-display');
        const themeToggle = document.getElementById('theme-toggle');
        const durationBtns = document.querySelectorAll('.duration-btn');
        const currentDateTimeSpan = document.getElementById('currentDateTime');
        const todayCountSpan = document.getElementById('todayCount');
        const motivationMessageSpan = document.getElementById('motivationMessage');

        // ---------- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ----------
        const CLICK_STIM_DURATION_NORMAL_MIN = 250;
        const CLICK_STIM_DURATION_NORMAL_MAX = 400;
        const CLICK_STIM_DURATION_SHORT = 100;
        const CLICK_SHORT_STIM_PROBABILITY = 0.1;

        const INTER_STIM_NORMAL_MIN = 1000;
        const INTER_STIM_NORMAL_MAX = 2000;
        const INTER_STIM_LONG_MIN = 3000;
        const INTER_STIM_LONG_MAX = 5000;
        const LONG_PAUSE_PROBABILITY = 0.2;

        // ---------- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π ----------
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            currentDateTimeSpan.textContent = now.toLocaleString('ru-RU', options);
        }

        function updateTodayCount() {
            if (!currentAccount || !accounts[currentAccount.name]) {
                todayCountSpan.textContent = '';
                return;
            }
            const today = new Date().toDateString();
            const todayTests = accounts[currentAccount.name].history.filter(r => 
                new Date(r.date).toDateString() === today
            ).length;
            todayCountSpan.textContent = `üìä –°–µ–≥–æ–¥–Ω—è –ø—Ä–æ–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤: ${todayTests}`;
        }

        function updateMotivationMessage() {
            const randomIndex = Math.floor(Math.random() * motivationMessages.length);
            motivationMessageSpan.textContent = motivationMessages[randomIndex];
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        setInterval(() => {
            updateDateTime();
            updateTodayCount();
            updateMotivationMessage();
        }, 60000);

        // ---------- –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ----------
        function showStatsPanel() {
            rightColumn.classList.add('visible');
            if (window.innerWidth <= 800) {
                setTimeout(() => {
                    rightColumn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 500);
            }
        }

        function hideStatsPanel() {
            rightColumn.classList.remove('visible');
        }

        // ---------- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–æ–π ----------
        function setTheme(theme) {
            if (theme === 'light') {
                body.classList.add('light-theme');
            } else {
                body.classList.remove('light-theme');
            }
            localStorage.setItem('gongo_theme', theme);
        }

        function toggleTheme() {
            if (body.classList.contains('light-theme')) {
                setTheme('dark');
            } else {
                setTheme('light');
            }
        }

        const savedTheme = localStorage.getItem('gongo_theme') || 'dark';
        setTheme(savedTheme);

        // ---------- –°–µ–Ω—Å–æ—Ä–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ ----------
        function setupTouchFeedback() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.addEventListener('touchstart', () => {
                    btn.classList.add('touch-pressed');
                }, { passive: true });
                
                btn.addEventListener('touchend', () => {
                    btn.classList.remove('touch-pressed');
                });
                
                btn.addEventListener('touchcancel', () => {
                    btn.classList.remove('touch-pressed');
                });
                
                btn.addEventListener('touchmove', () => {
                    btn.classList.remove('touch-pressed');
                });
            });
        }

        // ---------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π touch ----------
        function addTouchSupport(element, handler) {
            element.addEventListener('click', handler);
            element.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handler(e);
            }, { passive: false });
        }

        // ---------- –ê–∫–∫–∞—É–Ω—Ç—ã ----------
        function loadAccounts() {
            const saved = localStorage.getItem('gongo_accounts');
            accounts = saved ? JSON.parse(saved) : {};
            updateAccountSelect();
        }

        function saveAccounts() {
            localStorage.setItem('gongo_accounts', JSON.stringify(accounts));
        }

        function updateAccountSelect() {
            accountSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å --</option>';
            for (let name in accounts) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `${name} (${accounts[name].age} –ª–µ—Ç)`;
                accountSelect.appendChild(option);
            }
        }

        function updateActiveAccountDisplay() {
            if (currentAccount) {
                activeAccountDisplay.textContent = `‚úì –ê–∫—Ç–∏–≤–Ω—ã–π: ${currentAccount.name} (${currentAccount.age} –ª–µ—Ç)`;
                showLastResults();
                updateStatsAndGraph();
                historyPanel.style.display = 'block';
                showStatsPanel();
                updateTodayCount();
            } else {
                activeAccountDisplay.textContent = '';
                historyPanel.style.display = 'none';
                hideStatsPanel();
            }
        }

        function showLastResults() {
            if (!currentAccount || !accounts[currentAccount.name]) return;
            const history = accounts[currentAccount.name].history || [];
            const lastFive = history.slice(-5).reverse();
            historyList.innerHTML = '';
            if (lastFive.length === 0) {
                historyList.innerHTML = '<p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</p>';
                return;
            }
            lastFive.forEach((res) => {
                const date = new Date(res.date).toLocaleString('ru-RU', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `<strong>${date}</strong> | ${res.mode === 'greenonly' ? 'üåø –ó–µ–ª—ë–Ω—ã–π' : 'üî¥ –ö–ª–∏–∫'} | –£—Å–ø:${res.successes} –û—à:${res.errors} | –°—Ä:${res.avgReaction} –º—Å | –ú–∏–Ω:${res.minReaction} –º—Å | –ú–∞–∫—Å:${res.maxReaction} –º—Å`;
                historyList.appendChild(item);
            });
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ª–æ–º–∞–Ω–æ–π –ª–∏–Ω–∏–∏
        function drawLineChart(history) {
            if (!chartCanvas) return;
            const ctx = chartCanvas.getContext('2d');
            const width = chartCanvas.clientWidth;
            const height = chartCanvas.clientHeight;
            chartCanvas.width = width;
            chartCanvas.height = height;

            if (history.length === 0) {
                ctx.clearRect(0, 0, width, height);
                return;
            }

            const padding = 30;
            const graphWidth = width - 2 * padding;
            const graphHeight = height - 2 * padding;

            const accuracies = history.map(r => r.accuracy || 0);
            const reactionTimes = history.map(r => {
                const t = r.avgReaction || 0;
                return Math.min(t, 500);
            });

            const maxAcc = Math.max(...accuracies, 100);
            const minAcc = Math.min(...accuracies, 0);
            const maxReaction = Math.max(...reactionTimes, 500);
            const minReaction = Math.min(...reactionTimes, 0);

            ctx.clearRect(0, 0, width, height);
            
            ctx.strokeStyle = body.classList.contains('light-theme') ? '#b8d9ff' : '#2a4a6a';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= 4; i++) {
                let y = padding + (i / 4) * graphHeight;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.strokeStyle = body.classList.contains('light-theme') ? '#b8d9ff' : '#2a4a6a';
                ctx.stroke();
            }

            ctx.beginPath();
            ctx.strokeStyle = '#4a8ac0';
            ctx.lineWidth = 2;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';

            const stepX = graphWidth / (history.length - 1 || 1);
            for (let i = 0; i < history.length; i++) {
                const x = padding + i * stepX;
                const y = padding + graphHeight - ((accuracies[i] - minAcc) / (maxAcc - minAcc || 1)) * graphHeight;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            ctx.fillStyle = '#4a8ac0';
            for (let i = 0; i < history.length; i++) {
                const x = padding + i * stepX;
                const y = padding + graphHeight - ((accuracies[i] - minAcc) / (maxAcc - minAcc || 1)) * graphHeight;
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, 2 * Math.PI);
                ctx.fill();
            }

            ctx.beginPath();
            ctx.strokeStyle = '#9b4ac0';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 3]);
            for (let i = 0; i < history.length; i++) {
                const x = padding + i * stepX;
                const y = padding + graphHeight - ((reactionTimes[i] - minReaction) / (maxReaction - minReaction || 1)) * graphHeight;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.fillStyle = '#9b4ac0';
            for (let i = 0; i < history.length; i++) {
                const x = padding + i * stepX;
                const y = padding + graphHeight - ((reactionTimes[i] - minReaction) / (maxReaction - minReaction || 1)) * graphHeight;
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, 2 * Math.PI);
                ctx.fill();
            }

            chartLabels.innerHTML = '';
            for (let i = 0; i < history.length; i++) {
                const label = document.createElement('span');
                label.textContent = i + 1;
                chartLabels.appendChild(label);
            }
        }

        function updateStatsAndGraph() {
            if (!currentAccount || !accounts[currentAccount.name]) return;
            
            const allHistory = accounts[currentAccount.name].history || [];
            const filteredHistory = allHistory.filter(r => r.duration == currentStatsDuration);
            
            if (filteredHistory.length === 0) {
                statsSummary.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</p>';
                drawLineChart([]);
                chartLabels.innerHTML = '';
                return;
            }

            const recentHistory = filteredHistory.slice(-10);

            const totalTests = filteredHistory.length;
            const avgAccuracy = filteredHistory.reduce((acc, r) => acc + (r.accuracy || 0), 0) / totalTests;
            const bestAccuracy = Math.max(...filteredHistory.map(r => r.accuracy || 0));
            const worstAccuracy = Math.min(...filteredHistory.map(r => r.accuracy || 0));
            
            const avgReactionAll = filteredHistory.reduce((acc, r) => acc + (r.avgReaction || 0), 0) / totalTests;
            const bestReaction = Math.min(...filteredHistory.map(r => r.avgReaction || 0));
            const worstReaction = Math.max(...filteredHistory.map(r => r.avgReaction || 0));

            let trend = '‚Äî';
            let trendClass = 'trend-equal';
            if (filteredHistory.length >= 2) {
                const last = filteredHistory[filteredHistory.length-1].accuracy || 0;
                const prev = filteredHistory[filteredHistory.length-2].accuracy || 0;
                if (last > prev) {
                    trend = '‚Üë –ª—É—á—à–µ';
                    trendClass = 'trend-up';
                } else if (last < prev) {
                    trend = '‚Üì —Ö—É–∂–µ';
                    trendClass = 'trend-down';
                } else {
                    trend = '= –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π';
                }
            }

            statsSummary.innerHTML = `
                <div class="stats-row"><span>–¢–µ—Å—Ç–æ–≤ (${currentStatsDuration}—Å):</span> <strong>${totalTests}</strong></div>
                <div class="stats-row"><span>–°—Ä–µ–¥–Ω—è—è —Ç–æ—á–Ω–æ—Å—Ç—å:</span> <strong>${avgAccuracy.toFixed(1)}%</strong></div>
                <div class="stats-row"><span>–õ—É—á—à–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å:</span> <strong>${bestAccuracy.toFixed(1)}%</strong></div>
                <div class="stats-row"><span>–•—É–¥—à–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å:</span> <strong>${worstAccuracy.toFixed(1)}%</strong></div>
                <div class="stats-row"><span>–°—Ä–µ–¥–Ω—è—è —Ä–µ–∞–∫—Ü–∏—è:</span> <strong>${avgReactionAll.toFixed(0)} –º—Å</strong></div>
                <div class="stats-row"><span>–õ—É—á—à–∞—è —Ä–µ–∞–∫—Ü–∏—è:</span> <strong>${bestReaction.toFixed(0)} –º—Å</strong></div>
                <div class="stats-row"><span>–•—É–¥—à–∞—è —Ä–µ–∞–∫—Ü–∏—è:</span> <strong>${worstReaction.toFixed(0)} –º—Å</strong></div>
                <div class="stats-row"><span>–¢–µ–Ω–¥–µ–Ω—Ü–∏—è:</span> <span class="trend-indicator ${trendClass}">${trend}</span></div>
            `;

            drawLineChart(recentHistory);
        }

        // ---------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ ----------
        addTouchSupport(loadAccountBtn, () => {
            const name = accountSelect.value;
            if (name && accounts[name]) {
                currentAccount = { name, ...accounts[name] };
                updateActiveAccountDisplay();
                alert(`–ó–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–æ—Ñ–∏–ª—å: ${name}`);
            } else {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å');
            }
        });

        addTouchSupport(createAccountBtn, () => {
            const name = newName.value.trim();
            const age = parseInt(newAge.value);
            if (!name || !age) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –≤–æ–∑—Ä–∞—Å—Ç');
                return;
            }
            accounts[name] = { age, history: [] };
            saveAccounts();
            updateAccountSelect();
            newName.value = '';
            newAge.value = '';
            currentAccount = { name, age, history: [] };
            updateActiveAccountDisplay();
            alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω');
        });

        addTouchSupport(deleteAccountBtn, () => {
            const name = accountSelect.value;
            if (name && accounts[name]) {
                if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å ${name}?`)) {
                    delete accounts[name];
                    saveAccounts();
                    updateAccountSelect();
                    if (currentAccount?.name === name) {
                        currentAccount = null;
                        updateActiveAccountDisplay();
                    }
                }
            }
        });

        addTouchSupport(startBtn, startTest);
        addTouchSupport(resetBtn, resetToMenu);

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        durationBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                durationBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentStatsDuration = btn.dataset.duration;
                updateStatsAndGraph();
            });
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
        themeToggle.addEventListener('click', toggleTheme);

        function saveResultToAccount(successes, errors, misses, total, accuracy, avgReaction, minReaction, maxReaction) {
            if (!currentAccount) return;
            const result = {
                date: new Date().toISOString(),
                mode,
                duration: testDuration,
                successes,
                errors,
                misses,
                total,
                accuracy,
                avgReaction: avgReaction || 0,
                minReaction: minReaction || 0,
                maxReaction: maxReaction || 0
            };
            accounts[currentAccount.name].history.push(result);
            saveAccounts();
            showLastResults();
            updateStatsAndGraph();
            updateTodayCount();
        }

        // ---------- –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫—Ä—É–∂–æ–∫ ----------
        document.addEventListener('contextmenu', (e) => e.preventDefault());

        function handlePress(e) {
            if (!testActive) return;
            e.preventDefault();

            if (mode === 'greenonly') {
                if (currentStimulus === 'green') {
                    const reactionTime = Date.now() - greenStimulusStart;
                    reactionTimes.push(reactionTime);
                    updateReactionStats();
                    successes++;
                    successSpan.textContent = successes;
                    clearCurrentStimulus(true);
                } else {
                    errors++;
                    errorSpan.textContent = errors;
                    if (currentStimulus === 'red') {
                        clearCurrentStimulus(true);
                    }
                }
            } else {
                if (currentStimulus === 'green') {
                    const reactionTime = Date.now() - greenStimulusStart;
                    reactionTimes.push(reactionTime);
                    updateReactionStats();
                    successes++;
                    successSpan.textContent = successes;
                    clearCurrentStimulus(true);
                } else {
                    errors++;
                    errorSpan.textContent = errors;
                    if (currentStimulus === 'red') {
                        clearCurrentStimulus(true);
                    }
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º—ã—à–∏ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        document.addEventListener('mousedown', (e) => {
            if (e.button === 0) handlePress(e);
        });

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.key === ' ') {
                e.preventDefault();
                handlePress(e);
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å–∞–Ω–∏–π —Ç–æ–ª—å–∫–æ –Ω–∞ –∫—Ä—É–∂–∫–µ –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞
        circle.addEventListener('touchstart', (e) => {
            if (testActive) {
                e.preventDefault();
                handlePress(e);
            }
        }, { passive: false });

        function updateReactionStats() {
            if (reactionTimes.length === 0) {
                avgReactionSpan.textContent = '-';
                minReactionSpan.textContent = '-';
                maxReactionSpan.textContent = '-';
                reactionQualitySpan.textContent = '-';
                return;
            }
            const sum = reactionTimes.reduce((a, b) => a + b, 0);
            const avg = sum / reactionTimes.length;
            const min = Math.min(...reactionTimes);
            const max = Math.max(...reactionTimes);
            
            avgReactionSpan.textContent = avg.toFixed(1);
            minReactionSpan.textContent = min.toFixed(1);
            maxReactionSpan.textContent = max.toFixed(1);

            let quality = '';
            if (avg < 200) quality = 'üî• –û—Ç–ª–∏—á–Ω–∞—è!';
            else if (avg < 300) quality = 'üëç –•–æ—Ä–æ—à–∞—è';
            else if (avg < 400) quality = 'üëå –°—Ä–µ–¥–Ω—è—è';
            else quality = 'üê¢ –ú–µ–¥–ª–µ–Ω–Ω–∞—è';
            reactionQualitySpan.textContent = quality;
        }

        function clearCurrentStimulus(clicked = false) {
            if (stimulusTimeout) {
                clearTimeout(stimulusTimeout);
                stimulusTimeout = null;
            }
            if (currentStimulus === 'green' && !clicked) {
                misses++;
                missSpan.textContent = misses;
            }
            currentStimulus = null;
            updateLight();
            scheduleNextStimulus();
        }

        function showStimulus() {
            if (!testActive) return;

            let isGreen;
            if (mode === 'greenonly') {
                isGreen = true;
            } else {
                isGreen = Math.random() < 0.5;
            }

            currentStimulus = isGreen ? 'green' : 'red';
            updateLight();

            let duration;
            if (Math.random() < CLICK_SHORT_STIM_PROBABILITY) {
                duration = CLICK_STIM_DURATION_SHORT;
            } else {
                duration = Math.random() * (CLICK_STIM_DURATION_NORMAL_MAX - CLICK_STIM_DURATION_NORMAL_MIN) + CLICK_STIM_DURATION_NORMAL_MIN;
            }

            if (currentStimulus === 'green') {
                greenStimulusStart = Date.now();
            }

            stimulusTimeout = setTimeout(() => {
                clearCurrentStimulus(false);
            }, duration);
        }

        function updateLight() {
            circle.classList.remove('green', 'red');
            if (currentStimulus === 'green') {
                circle.classList.add('green');
            } else if (currentStimulus === 'red') {
                circle.classList.add('red');
            }
        }

        function scheduleNextStimulus() {
            if (!testActive) return;

            let delay;
            if (Math.random() < LONG_PAUSE_PROBABILITY) {
                delay = Math.random() * (INTER_STIM_LONG_MAX - INTER_STIM_LONG_MIN) + INTER_STIM_LONG_MIN;
            } else {
                delay = Math.random() * (INTER_STIM_NORMAL_MAX - INTER_STIM_NORMAL_MIN) + INTER_STIM_NORMAL_MIN;
            }

            nextStimulusTimeout = setTimeout(() => {
                if (testActive) showStimulus();
            }, delay);
        }

        function startTest() {
            if (!currentAccount) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å');
                return;
            }

            mode = modeSelect.value;
            testDuration = parseInt(testDurationSelect.value);

            mainPanels.style.display = 'none';
            testArea.style.display = 'block';

            successes = 0; errors = 0; misses = 0;
            reactionTimes = [];
            successSpan.textContent = '0';
            errorSpan.textContent = '0';
            missSpan.textContent = '0';
            avgReactionSpan.textContent = '-';
            minReactionSpan.textContent = '-';
            maxReactionSpan.textContent = '-';
            reactionQualitySpan.textContent = '-';
            resultDiv.innerHTML = '';
            saveBtn.style.display = 'none';

            if (stimulusTimeout) clearTimeout(stimulusTimeout);
            if (nextStimulusTimeout) clearTimeout(nextStimulusTimeout);

            currentStimulus = null;
            updateLight();

            testActive = true;
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 100);

            scheduleNextStimulus();

            resetBtn.style.display = 'inline-block';

            setTimeout(() => {
                if (testActive) endTest();
            }, testDuration * 1000);
        }

        function updateTimer() {
            if (!testActive) return;
            const elapsed = (Date.now() - startTime) / 1000;
            timerEl.textContent = elapsed.toFixed(1) + ` / ${testDuration} —Å`;
            if (elapsed >= testDuration) endTest();
        }

        function endTest() {
            testActive = false;
            clearInterval(timerInterval);
            if (stimulusTimeout) clearTimeout(stimulusTimeout);
            if (nextStimulusTimeout) clearTimeout(nextStimulusTimeout);
            currentStimulus = null;
            updateLight();

            const total = successes + errors + misses;
            const accuracy = total > 0 ? (successes / total * 100) : 0;
            
            let avgReaction = 0, minReaction = 0, maxReaction = 0;
            if (reactionTimes.length > 0) {
                const sum = reactionTimes.reduce((a,b) => a+b, 0);
                avgReaction = sum / reactionTimes.length;
                minReaction = Math.min(...reactionTimes);
                maxReaction = Math.max(...reactionTimes);
            }

            let reactionQuality = '';
            if (reactionTimes.length === 0) reactionQuality = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            else if (avgReaction < 200) reactionQuality = '–û—Ç–ª–∏—á–Ω–∞—è';
            else if (avgReaction < 300) reactionQuality = '–•–æ—Ä–æ—à–∞—è';
            else if (avgReaction < 400) reactionQuality = '–°—Ä–µ–¥–Ω—è—è';
            else reactionQuality = '–ú–µ–¥–ª–µ–Ω–Ω–∞—è';

            resultDiv.innerHTML = `
                <h2>‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω</h2>
                <p>–ê–∫–∫–∞—É–Ω—Ç: ${currentAccount.name} (${currentAccount.age} –ª–µ—Ç)</p>
                <p>–†–µ–∂–∏–º: ${mode === 'greenonly' ? '–¢–æ–ª—å–∫–æ –∑–µ–ª—ë–Ω—ã–π' : '–ö–ª–∏–∫ (–∑–µ–ª—ë–Ω—ã–π/–∫—Ä–∞—Å–Ω—ã–π)'}</p>
                <p>–£—Å–ø–µ—Ö–æ–≤: ${successes}</p>
                <p>–û—à–∏–±–æ–∫: ${errors}</p>
                <p>–ü—Ä–æ–ø—É—Å–∫–æ–≤: ${misses}</p>
                <p>–í—Å–µ–≥–æ —Å—Ç–∏–º—É–ª–æ–≤: ${total}</p>
                <p>–¢–æ—á–Ω–æ—Å—Ç—å: ${accuracy.toFixed(1)}%</p>
                <p>–°—Ä–µ–¥–Ω—è—è —Ä–µ–∞–∫—Ü–∏—è: ${avgReaction.toFixed(1)} –º—Å</p>
                <p>–ú–∏–Ω. —Ä–µ–∞–∫—Ü–∏—è: ${minReaction.toFixed(1)} –º—Å</p>
                <p>–ú–∞–∫—Å. —Ä–µ–∞–∫—Ü–∏—è: ${maxReaction.toFixed(1)} –º—Å</p>
                <p>–û—Ü–µ–Ω–∫–∞: ${reactionQuality}</p>
            `;

            saveBtn.style.display = 'inline-block';
            saveBtn.onclick = () => saveResults(
                currentAccount.name, 
                successes, errors, misses, total, accuracy, 
                avgReaction, minReaction, maxReaction, reactionQuality
            );

            saveResultToAccount(successes, errors, misses, total, accuracy, avgReaction, minReaction, maxReaction);
        }

        function saveResults(name, successes, errors, misses, total, accuracy, avgReaction, minReaction, maxReaction, quality) {
            const now = new Date();
            const timestamp = now.toLocaleString('ru-RU');
            const modeText = mode === 'greenonly' ? '–¢–æ–ª—å–∫–æ –∑–µ–ª—ë–Ω—ã–π' : '–ö–ª–∏–∫ (–∑–µ–ª—ë–Ω—ã–π/–∫—Ä–∞—Å–Ω—ã–π)';
            const content = `
–†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ê GO/NO-GO
=========================
–ò–º—è: ${name}
–í–æ–∑—Ä–∞—Å—Ç: ${currentAccount.age}
–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: ${timestamp}
–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${testDuration} —Å
–†–µ–∂–∏–º: ${modeText}

–£—Å–ø–µ—Ö–æ–≤: ${successes}
–û—à–∏–±–æ–∫: ${errors}
–ü—Ä–æ–ø—É—Å–∫–æ–≤ –∑–µ–ª—ë–Ω–æ–≥–æ: ${misses}
–í—Å–µ–≥–æ —Å—Ç–∏–º—É–ª–æ–≤: ${total}
–¢–æ—á–Ω–æ—Å—Ç—å: ${accuracy.toFixed(1)}%

–°–†–ï–î–ù–Ø–Ø –ë–´–°–¢–†–û–¢–ê –†–ï–ê–ö–¶–ò–ò: ${avgReaction.toFixed(1)} –º—Å
–ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø –†–ï–ê–ö–¶–ò–Ø: ${minReaction.toFixed(1)} –º—Å
–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø –†–ï–ê–ö–¶–ò–Ø: ${maxReaction.toFixed(1)} –º—Å
–û–¶–ï–ù–ö–ê: ${quality}
            `.trim();

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = `results_${name}_${now.toISOString().slice(0,10)}.txt`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function resetToMenu() {
            if (testActive) {
                testActive = false;
                clearInterval(timerInterval);
                clearTimeout(stimulusTimeout);
                clearTimeout(nextStimulusTimeout);
                currentStimulus = null;
                updateLight();
            }
            testArea.style.display = 'none';
            mainPanels.style.display = 'flex';
            resetBtn.style.display = 'none';
            saveBtn.style.display = 'none';
            resultDiv.innerHTML = '';
            
            updateDateTime();
            updateMotivationMessage();
            updateTodayCount();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadAccounts();
        updateActiveAccountDisplay();
        updateDateTime();
        updateMotivationMessage();
        setupTouchFeedback(); // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–µ–Ω—Å–æ—Ä–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é
        
        setInterval(() => {
            updateDateTime();
            updateMotivationMessage();
            updateTodayCount();
        }, 60000);
    </script>
</body>
</html>